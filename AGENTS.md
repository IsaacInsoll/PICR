# PICR Repository Guidelines

PICR is an open-source photo/video gallery for photographers to share media with clients. Deployed via Docker for self-hosting, with a React Native companion app.

## Project Links

| Resource           | URL                                                                |
| ------------------ | ------------------------------------------------------------------ |
| GitHub Repository  | https://github.com/IsaacInsoll/PICR                                |
| GitHub Issues      | https://github.com/IsaacInsoll/PICR/issues                         |
| Documentation Site | https://isaacinsoll.github.io/PICR/                                |
| Docker Hub         | https://hub.docker.com/r/isaacinsoll/picr                          |
| iOS App            | https://apps.apple.com/us/app/picr-client/id6748066012             |
| Android App        | https://play.google.com/store/apps/details?id=com.isaacinsoll.picr |

## Working on GitHub Issues

When working on a GitHub issue:

1. **Reference the issue** in commits: `‚ú® #42 add feature description`
2. **Understand the full context** - fetch the issue URL to read all comments and discussion
3. **Check for labels** - `currently working on` means it's in progress
4. **Test thoroughly** - ask the user to run `npm run workflow` before considering work complete
5. **Update related docs** if the change affects user-facing behavior

### Fetching Issue Details

To understand an issue fully, fetch it:

```
https://github.com/IsaacInsoll/PICR/issues/<number>
```

Or use `gh issue view <number>` if the GitHub CLI is available.

## Project Structure

| Directory    | Purpose                                                            | Has AGENTS.md |
| ------------ | ------------------------------------------------------------------ | ------------- |
| `backend/`   | Node/Express/Drizzle GraphQL API, media processing, notifications  | Yes           |
| `frontend/`  | Vite + React 19 admin UI                                           | Yes           |
| `shared/`    | Code shared between frontend and app (types, queries, utilities)   | Yes           |
| `app/`       | Expo/React Native mobile client                                    | Yes           |
| `tests/`     | API integration tests (Vitest) + frontend smoke tests (Playwright) | Yes           |
| `lightroom/` | Lightroom Classic plugin prototype (Lua)                           | Yes           |
| `docs/`      | GitHub Pages documentation site                                    | No            |

**Read the subsystem AGENTS.md files when working in those directories** - they contain detailed patterns, code examples, and troubleshooting guides.

## Autogenerated Files (Do Not Edit)

These files are regenerated by `npm run gql`:

- `./graphql-types.ts`
- `./schema.graphql`
- `shared/urql/graphql.schema.json`
- `shared/gql/*`

## User Model & Access Control

This is a cross-cutting concern affecting backend auth, frontend routing, and app access.

### Two User Types (Same Table)

Users are stored in `backend/db/models/dbUser.ts` with two modes:

| Type      | Authentication                | Access Level                            | Created By               |
| --------- | ----------------------------- | --------------------------------------- | ------------------------ |
| **Admin** | `username` + `hashedPassword` | Full admin to folders under home folder | `editAdminUser` mutation |
| **Link**  | `uuid` (in URL/header)        | View-only to folders under home folder  | `editUser` mutation      |

### Home Folder = Access Scope

- Every user has a `folderId` (their "home folder")
- Users can only access content within their home folder's subtree
- `folderId = 1` (root) = full access to everything
- Admin users get `Admin` permissions; Link users get `View` permissions

### Public Link URL Pattern

```
/s/:uuid/:folderId/:fileId?
```

- Frontend detects `/s/:uuid/...` routes and sends UUID in request header
- GraphQL auth checks JWT first, falls back to UUID header

### Comment Permissions

Per-user setting (`commentPermissions`): `edit` | `read` | `none`

- Only `edit` allows creating comments
- `read` vs `none` distinction not currently enforced on backend

### Link Modes

`linkMode` controls download behavior:

- `final_delivery` - Downloads enabled
- `proof_no_downloads` - Downloads disabled (proofing workflow)

### Known Issues / Tech Debt

- Admin vs Link split is implicit - both fields can be set simultaneously
- `userType = User` exists in enums but no mutation creates it
- Access logs filter to Link users regardless of `userType` argument

## Build, Test & Development Commands

```bash
# Development
npm start                    # Full dev stack (backend + frontend + Docker DB)
npm run start:server         # Backend only (with nodemon)
npm run start:client         # Frontend only (Vite dev server)
npm run start:db             # Database only (Docker)

# Building
cd backend && npm run build  # TypeScript ‚Üí dist/server (for Docker image)
cd frontend && npm run build # Vite production build
cd app && npx expo export --platform android  # or --platform ios on macOS

# Testing
npm run workflow             # Full CI workflow (user runs this manually)
npm run test:api             # Backend Vitest integration suite (AI may run locally)
npm run test:e2e             # Playwright smoke tests (AI may run locally)
npm run test:e2e:fresh       # Rebuild dist artifacts, then run Playwright smoke tests

# Code Generation
npm run gql                  # Regenerate GraphQL types (safe to run anytime)

# Type Checking
cd backend && npx tsc --noEmit   # Backend type-check
cd frontend && npx tsc --noEmit  # Frontend type-check
cd shared && npx tsc --noEmit    # Shared type-check
cd app && npx tsc --noEmit       # App type-check

# Formatting
npm run format               # Apply Prettier formatting across the repo
npm run format:check         # Verify formatting only (same check used in CI)
```

### After Making Changes

Always suggest running the relevant build as a basic validation:

- Backend changes ‚Üí `cd backend && npm run build`
- Frontend changes ‚Üí `cd frontend && npm run build`
- App changes ‚Üí `cd app && npx expo export --platform android`

Run lint for each touched subsystem before finalizing changes:

- Shared changes ‚Üí `cd shared && npm run lint`
- Backend changes ‚Üí `cd backend && npm run lint`
- Frontend changes ‚Üí `cd frontend && npm run lint`
- App changes ‚Üí `cd app && npm run lint`

Run TypeScript checks for each touched subsystem before finalizing changes:

- Shared changes ‚Üí `cd shared && npx tsc --noEmit`
- Backend changes ‚Üí `cd backend && npx tsc --noEmit`
- Frontend changes ‚Üí `cd frontend && npx tsc --noEmit`
- App changes ‚Üí `cd app && npx tsc --noEmit`

Run formatting checks before finalizing:

- `npm run format:check`

Test scope note:

- `tests/api/` is the Vitest suite for backend API e2e coverage.
- `tests/e2e/` is for basic frontend browser smoke tests.
- Do not add frontend/app unit tests to these integration suites.
- In `tests/api/`, prefer shared GraphQL operations from `shared/urql/*` and existing GraphQL test helpers over inline query strings.
- In `tests/e2e/` Playwright smoke tests, keep GraphQL operations local to `tests/e2e/` and avoid importing enums from `graphql-types.ts`.
- Local E2E runs use Docker images built from `dist` output artifacts, not live `frontend/src` files.
- Run a fresh local build before E2E when validating frontend code changes (`npm run test:e2e:fresh` is preferred).

**Do not run `npm run workflow` directly.** Ask the user to run it themselves.
**`npm run test:api` and `npm run test:e2e` may be run by AI locally anytime.**

## Coding Style & Conventions

- **TypeScript-first** - Avoid `any`, use proper types
- **Functional React** - No class components
- **Prettier 3** - Two-space indentation, format before committing
- **ESLint** - React hooks rules, React Compiler compatibility
- **No console.log** - Use proper logging or remove before committing

### Naming Conventions

| Type                | Convention  | Example                    |
| ------------------- | ----------- | -------------------------- |
| Components/Types    | PascalCase  | `FolderView`, `UserType`   |
| Functions/Variables | camelCase   | `getUserById`, `isLoading` |
| Files (components)  | PascalCase  | `FolderView.tsx`           |
| Files (utilities)   | camelCase   | `formatDate.ts`            |
| Database models     | db prefix   | `dbUser`, `dbFolder`       |
| GraphQL types       | Type suffix | `userType`, `folderType`   |

## Git & Commit Guidelines

### Commit Format

```
<gitmoji> [subsystem] <description>

Examples:
üêõ [backend] fix folder rename crash
‚ú® [frontend] add gallery search
üìù [docs] update installation guide
‚ôªÔ∏è [shared] refactor date formatting
```

Common gitmoji:

- ‚ú® New feature
- üêõ Bug fix
- ‚ôªÔ∏è Refactor
- üìù Documentation
- üé® Style/formatting
- ‚ö° Performance
- üîß Configuration
- üöÄ Release

### Important Rules

- **Releases**: Must be done by human running `npm run release` - AI may only suggest the command
- **Migrations**: Call out DB migrations, GraphQL schema changes, or new env vars in PR descriptions
- **Codegen**: Run `npm run gql` after schema changes and commit the generated files

## Environment Variables

See `.env.example` for all available variables with documentation. Key ones:

| Variable       | Required | Description                                     |
| -------------- | -------- | ----------------------------------------------- |
| `DATABASE_URL` | Yes      | PostgreSQL connection string                    |
| `BASE_URL`     | Yes      | Server URL ending with `/` (for social sharing) |
| `NODE_ENV`     | No       | `development` \| `test` \| `production`         |
| `USE_POLLING`  | No       | Enable file watcher polling (for Docker/NAS)    |

## Cross-References

- **Database schema**: See `backend/database-erd.md` for entity relationship diagram
- **GraphQL API**: See `schema.graphql` for full API, `backend/AGENTS.md` for patterns
- **Frontend patterns**: See `frontend/AGENTS.md` for React/Mantine/URQL details
- **Shared code**: See `shared/AGENTS.md` for what can/cannot be shared
- **Testing**: See `tests/AGENTS.md` for test patterns and Docker setup
