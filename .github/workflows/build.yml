# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
name: PICR Build

on:
  workflow_call:

jobs:
  build:
    name: PICR Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js from .nvmrc
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      # BACKEND
      - name: 'ğŸ—ƒï¸ [shared] Install Dependencies'
        run: cd shared && npm ci
      - name: 'ğŸ—ƒï¸ [backend] Install Dependencies'
        run: cd backend && npm ci
      - name: 'ğŸ—ƒï¸ [shared] Lint'
        run: cd shared && npm run lint
      - name: 'ğŸ—ƒï¸ [backend] Lint'
        run: cd backend && npm run lint
      - name: 'ğŸ—ƒï¸ [backend] Build (TSC + artifact files)'
        # backend build also copies drizzle migrations and backend package files into dist/
        run: cd backend && npm run build
      - name: 'ğŸ—ƒï¸ [backend] Install Dependencies'
        run: cd dist && npm ci

      # LIGHTROOM PLUGIN (before frontend so vite copies it to dist/public/)
      - name: 'ğŸ”Œ [lightroom] Build plugin zip'
        run: npm run build:lightroom

      # FRONTEND
      - name: 'ğŸ’„ [frontend] Install Dependencies'
        run: cd frontend && npm ci
      - name: 'ğŸ’„ [frontend] Lint'
        run: cd frontend && npm run lint
      - name: 'ğŸ’„ [frontend] Build (vite)'
        run: cd frontend && npm run build -- --logLevel error

      # APP
      # Not needed for artifact, just checking that it didn't break something
      # Hermes won't compile on arm so skip it
      - name: 'ğŸ“± [app] Install Dependencies'
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        run: cd app && npm ci
      - name: 'ğŸ“± [app] Lint'
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        run: cd app && npm run lint
      - name: 'ğŸ“± [app] Build (expo export)'
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        shell: bash
        run: |
          set -euo pipefail
          cd app
          npx expo export --platform ios 2>&1 | awk '
            /^â€º (Assets|ios bundles|android bundles|web bundles|Files) \(/ { skip=1; next }
            skip && NF==0 { skip=0; next }
            skip { next }
            { print }
          '

      # TESTS
      - name: 'ğŸ§ª  [tests] download sample files'
        run: mkdir -p ./tests/env && wget --no-verbose https://photosummaryapp.com/picr-demo-data.zip --output-document=./tests/env/sample.zip
      - name: 'ğŸ§ª [test] Install Dependencies'
        run: npm ci
      - name: 'ğŸ§ª [test] run backend tests (vitest)'
        run: npm run test

      # ARTIFACT
      - uses: actions/upload-artifact@v4
        if: ${{ !env.ACT }}
        name: 'ğŸ—œï¸ Generate Build Artifacts'
        with:
          name: picr-build-${{ github.sha }}
          path: ./dist/
          if-no-files-found: error
